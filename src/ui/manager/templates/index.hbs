<!-- Page Header -->
<div class="page-header">
    <h1 class="greeting">Codebase Memory Manager</h1>
    <p class="greeting-sub">Semantic search across your indexed codebases</p>
</div>

<!-- Alert Messages -->
{{#if message}}
<div class="alert alert-{{messageType}}">{{message}}</div>
{{/if}}

<!-- Tab Navigation -->
<div class="tabs">
    <button class="tab-btn active" onclick="switchTab('search', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
            <circle cx="11" cy="11" r="8"/>
            <path d="m21 21-4.35-4.35"/>
        </svg>
        Search
    </button>
    <button class="tab-btn" onclick="switchTab('manage', this)">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 18px; height: 18px;">
            <path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
        </svg>
        Manage Codebases
        <span class="badge badge-blue" style="margin-left: 0.5rem;">{{codebases.length}}</span>
    </button>
</div>

<!-- Search Tab Content -->
<div id="searchTab" class="tab-content active">

<!-- Hero Search Section -->
<div class="card hero-search">
    <div class="card-header">
        <div>
            <h2 class="card-title" style="font-size: 1.5rem; margin-bottom: 0.5rem;">Search Your Code</h2>
            <p class="card-subtitle">Find functions, classes, patterns, and more across all your codebases</p>
        </div>
    </div>
    <form method="POST" action="/search">
        <div class="form-group">
            <label class="form-label">Search Query</label>
            <input type="text" name="query" class="form-input" style="font-size: 1rem; padding: 1rem;" placeholder="e.g., authentication function, error handling, database connection..." value="{{searchQuery}}" required autofocus>
        </div>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
                <label class="form-label">Codebase</label>
                <select name="codebaseName" class="form-input">
                    <option value="">All Codebases</option>
                    {{#each codebases}}
                    <option value="{{name}}">{{name}}</option>
                    {{/each}}
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Max Results</label>
                <select name="maxResults" class="form-input">
                    <option value="5" {{#if (eq maxResults 5)}}selected{{/if}}>5</option>
                    <option value="10" {{#if (eq maxResults 10)}}selected{{/if}}>10</option>
                </select>
            </div>
        </div>
        <div style="display: flex; gap: 1.5rem; margin-bottom: 1rem;">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="excludeTests" value="true" {{#if excludeTests}}checked{{/if}} style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-size: 0.875rem;">Exclude test files</span>
            </label>
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="excludeLibraries" value="true" {{#if excludeLibraries}}checked{{/if}} style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-size: 0.875rem;">Exclude library files</span>
            </label>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            {{#if searchQuery}}
            <a href="/" class="btn btn-primary" style="flex: 1; padding: 1rem; display: flex; align-items: center; justify-content: center; text-decoration: none;">
                Clear Results
            </a>
            <button type="submit" class="btn btn-ghost" style="padding: 1rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                Search
            </button>
            {{else}}
            <button type="submit" class="btn btn-primary" style="flex: 1; padding: 1rem; font-size: 1rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px;">
                    <circle cx="11" cy="11" r="8"/>
                    <path d="m21 21-4.35-4.35"/>
                </svg>
                Search
            </button>
            {{/if}}
        </div>
    </form>

    {{#if searchResults}}
    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border-color);">
        <h3 style="font-size: 1.25rem; margin-bottom: 1rem;">Results ({{searchResults.length}})</h3>
        {{#each searchResults}}
        <div class="search-result" data-expanded="false" onclick="toggleSearchResult(this)">
            <div class="result-header" style="cursor: pointer;">
                <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">
                    <svg class="expand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; transition: transform 0.2s;">
                        <polyline points="9 18 15 12 9 6"/>
                    </svg>
                    <code style="font-size: 0.875rem; color: var(--text-primary);">{{filePath}}</code>
                </div>
                <span class="badge {{confidenceClass similarityScore}}">{{toFixed similarityScore 2}}</span>
            </div>
            <div class="result-details" style="display: none; margin-top: 0.75rem;">
                <div style="margin: 0.5rem 0;">
                    <span class="badge badge-green">{{language}}</span>
                    <span class="badge badge-orange">{{chunkType}}</span>
                    <span style="font-size: 0.8125rem; color: var(--text-secondary); margin-left: 0.5rem;">
                        Lines {{startLine}}-{{endLine}}
                    </span>
                </div>
                <pre style="background: var(--bg-surface); padding: 1rem; border-radius: 8px; overflow-x: auto; font-size: 0.875rem;"><code>{{content}}</code></pre>
                <button class="btn btn-ghost btn-sm" onclick="event.stopPropagation(); copyToClipboard(this, `{{content}}`)">
                    Copy
                </button>
            </div>
        </div>
        {{/each}}
    </div>
    {{else}}
    {{#if searchQuery}}
    <div class="empty-state" style="margin-top: 2rem;">
        <p>No results found for "{{searchQuery}}"</p>
    </div>
    {{/if}}
    {{/if}}
</div>
</div>

<!-- Manage Codebases Tab Content -->
<div id="manageTab" class="tab-content">
<!-- Codebases Section -->
<div style="margin-top: 2rem;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;" id="codebasesHeader">
        <h2 style="font-size: 1.25rem; font-weight: 600;">Your Codebases</h2>
        <button type="button" class="btn btn-primary" onclick="showIngestForm()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                <line x1="12" y1="5" x2="12" y2="19"/>
                <line x1="5" y1="12" x2="19" y2="12"/>
            </svg>
            Add Codebase
        </button>
    </div>

    <div class="card" id="codebasesList">
        {{#if codebases.length}}
        <table>
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Chunks</th>
                    <th>Files</th>
                    <th>Last Indexed</th>
                    <th style="width: 60px;"></th>
                </tr>
            </thead>
            <tbody>
                {{#each codebases}}
                <tr>
                    <td>
                        <a href="/codebase/{{urlEncode name}}" style="color: var(--accent); font-weight: 500;">
                            {{displayName name}}
                        </a>
                    </td>
                    <td><span class="badge badge-blue">{{chunkCount}}</span></td>
                    <td><span class="badge badge-green">{{fileCount}}</span></td>
                    <td style="font-size: 0.875rem; color: var(--text-secondary);">{{daysSince lastIngestion}}</td>
                    <td>
                        <div style="position: relative;">
                            <button type="button" class="btn btn-ghost btn-sm" onclick="toggleActionsMenu(event, '{{name}}')" style="padding: 0.25rem 0.5rem;">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                    <circle cx="12" cy="12" r="1"/>
                                    <circle cx="12" cy="5" r="1"/>
                                    <circle cx="12" cy="19" r="1"/>
                                </svg>
                            </button>
                            <div id="actions-menu-{{name}}" class="actions-menu" style="display: none;">
                                <button type="button" onclick="showRenameModal('{{name}}'); closeActionsMenu('{{name}}')">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                                    </svg>
                                    Rename
                                </button>
                                <button type="button" onclick="confirmRemove('{{name}}', '{{displayName name}}'); closeActionsMenu('{{name}}')" style="color: var(--danger);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px;">
                                        <polyline points="3 6 5 6 21 6"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                    </svg>
                                    Remove
                                </button>
                            </div>
                        </div>
                    </td>
                </tr>
                {{/each}}
            </tbody>
        </table>
        {{else}}
        <div class="empty-state">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 64px; height: 64px; opacity: 0.5; margin-bottom: 1rem;">
                <path d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"/>
            </svg>
            <p>No codebases found</p>
            <p style="font-size: 0.875rem; margin-top: 0.5rem; color: var(--text-secondary);">
                Click "Add Codebase" to get started
            </p>
        </div>
        {{/if}}
    </div>
</div>

<!-- Ingest Form (Hidden by default) -->
<div id="ingestFormContainer" class="card" style="margin-top: 2rem; display: none;">
    <div class="card-header">
        <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
            <div>
                <h3 class="card-title">Add New Codebase</h3>
                <p class="card-subtitle">Index a directory for semantic search</p>
            </div>
            <button type="button" class="btn btn-ghost" onclick="hideIngestForm()">×</button>
        </div>
    </div>
    <form method="POST" action="/ingest" id="ingestForm">
        <div class="form-group">
            <label class="form-label">Codebase Name</label>
            <input type="text" name="name" id="codebaseName" class="form-input" placeholder="my project" required>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                Use spaces or hyphens - spaces will be shown as title case in the UI
            </p>
        </div>
        <div class="form-group">
            <label class="form-label">Directory Path</label>
            <div style="display: flex; gap: 0.5rem;">
                <input type="text" name="path" id="pathInput" class="form-input" placeholder="/path/to/codebase" required style="flex: 1;">
                <button type="button" class="btn btn-primary" onclick="selectFolder()" id="folderPickerBtn">
                    Browse...
                </button>
            </div>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;" id="folderPickerHelp">
                Click "Browse..." to select a folder, or enter path manually
            </p>
        </div>
        <div class="form-group">
            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                <input type="checkbox" name="respectGitignore" value="true" checked style="width: 18px; height: 18px; cursor: pointer;">
                <span style="font-size: 0.875rem;">Respect .gitignore (recommended)</span>
            </label>
            <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; margin-left: 1.625rem;">
                Skip files and folders listed in .gitignore (e.g., node_modules, build artifacts)
            </p>
        </div>
        <div style="display: flex; gap: 0.75rem;">
            <button type="button" class="btn btn-ghost" onclick="hideIngestForm()">Cancel</button>
            <button type="submit" class="btn btn-primary" id="ingestSubmitBtn">Start Ingestion</button>
        </div>
    </form>
    
    <!-- Ingestion Progress (Hidden by default) -->
    <div id="ingestionProgress" style="display: none; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
        <h4 style="font-size: 1rem; margin-bottom: 1rem;">Ingestion Progress</h4>
        <div style="margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.25rem;">
                <span id="progressPhase" style="font-size: 0.875rem; color: var(--text-secondary);">Initializing...</span>
                <span id="progressPercent" style="font-size: 0.875rem; font-weight: 500;">0%</span>
            </div>
            <div style="background: var(--bg-surface); height: 8px; border-radius: 4px; overflow: hidden;">
                <div id="progressBar" style="background: var(--accent); height: 100%; width: 0%; transition: width 0.3s ease;"></div>
            </div>
        </div>
        <p id="progressDetails" style="font-size: 0.8125rem; color: var(--text-secondary); margin-top: 0.5rem;">
            Preparing to ingest codebase...
        </p>
    </div>
</div>
</div>

<!-- Rename Modal -->
<div id="renameModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Rename Codebase</h3>
            <button type="button" class="btn btn-ghost" onclick="closeRenameModal()">×</button>
        </div>
        <form method="POST" action="/rename">
            <input type="hidden" name="oldName" id="renameOldName">
            <div class="form-group">
                <label class="form-label">Rename</label>
                <div style="display: flex; align-items: center; gap: 0.75rem;">
                    <input type="text" id="renameCurrentName" class="form-input" disabled style="flex: 1;">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 20px; height: 20px; color: var(--text-secondary); flex-shrink: 0;">
                        <line x1="5" y1="12" x2="19" y2="12"/>
                        <polyline points="12 5 19 12 12 19"/>
                    </svg>
                    <input type="text" name="newName" id="renameNewName" class="form-input" placeholder="new-name" required style="flex: 1;">
                </div>
                <p style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem;">
                    Use spaces or hyphens - spaces will be shown as title case in the UI
                </p>
            </div>
            <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                <button type="button" class="btn btn-ghost" onclick="closeRenameModal()">Cancel</button>
                <button type="submit" class="btn btn-primary">Rename</button>
            </div>
        </form>
    </div>
</div>

<!-- Folder Browser Modal -->
<div id="folderBrowserModal" class="modal" style="display: none;">
    <div class="modal-content" style="max-width: 600px;">
        <div class="modal-header">
            <h3>Select Folder</h3>
            <button type="button" class="btn btn-ghost" onclick="closeFolderBrowserModal()">×</button>
        </div>
        <div style="margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.75rem; background: var(--bg-surface); border-radius: 8px; font-family: monospace; font-size: 0.875rem;">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 16px; height: 16px; flex-shrink: 0;">
                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                </svg>
                <span id="currentPathDisplay" style="flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">Loading...</span>
            </div>
        </div>
        <div id="folderLoadingIndicator" style="display: none; text-align: center; padding: 1rem; color: var(--text-secondary);">
            Loading folders...
        </div>
        <div id="folderList" style="max-height: 400px; overflow-y: auto; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem;">
            <!-- Folders will be loaded here -->
        </div>
        <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
            <button type="button" class="btn btn-ghost" onclick="closeFolderBrowserModal()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="selectCurrentFolder()">Select This Folder</button>
        </div>
    </div>
</div>
